- type: serial
  steps:
    - name: "Run Difftests"
      service: epiquerytest     
      exclude: (^deploy.*|^master_mock$)
      command: make test/codeship

    - name: "Push to ECR"
      service: epiquery      
      type: push
      exclude: (^deploy.*|^master_mock$)
      image_name: 054501475751.dkr.ecr.us-east-1.amazonaws.com/glg/epiquery2
      registry: https://054501475751.dkr.ecr.us-east-1.amazonaws.com
      dockercfg_service: dockercfg_generator
      image_tag: "{{ .CommitID }}"

    - name: "Tag build as Latest"
      service: epiquery  
      type: push    
      tag: ^master_mock_A
      image_name: 054501475751.dkr.ecr.us-east-1.amazonaws.com/glg/epiquery2
      registry: https://054501475751.dkr.ecr.us-east-1.amazonaws.com
      dockercfg_service: dockercfg_generator

    - name: "Tag build as Deploy2"
      service: epiquery  
      type: push    
      tag: ^master_mock_B
      image_name: 054501475751.dkr.ecr.us-east-1.amazonaws.com/glg/epiquery2
      registry: https://054501475751.dkr.ecr.us-east-1.amazonaws.com
      dockercfg_service: dockercfg_generator
      image_tag: "deploy2"

- name: "Tag build as Deploy2"
      service: epiquery  
      type: push    
      tag: ^master_mock_A
      image_name: 054501475751.dkr.ecr.us-east-1.amazonaws.com/glg/epiquery2
      registry: https://054501475751.dkr.ecr.us-east-1.amazonaws.com
      dockercfg_service: dockercfg_generator
      image_tag: "deployA"

    - name: "Update Service"
      tag: ^master_mock
      service: awsdeployment
      command: aws ecs update-service --cluster epistream --service epistream --force-new-deployment
